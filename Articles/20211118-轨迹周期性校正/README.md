# 蛋白配体模拟周期性校正

### 0. Intro

主体模拟的轨迹得到之后，有时候会发现体系中的蛋白或者配体有跨盒子的现象，这时候就需要对轨迹的周期性边界条件（PBC）进行校正。一来可以避免分析过程中出现意外情况（比如RMSD曲线有较大的突跃和突降等），二来也是可以获得较为美观的轨迹，方便我们直接观察。

后文将简要阐述我最近遇到的和周期性校正相关的事情。有关周期性校正的更多信息和案例，请参考网上的更多教程。或许单一的教程不足以解决你的问题，但多看多想，互相补充，慢慢就有所体悟了。

1. http://blog.sciencenet.cn/blog-548663-981600.html
2. http://jerkwin.github.io/GMX/GMXprg/#gmx-trjconv-转换和操控轨迹文件翻译-黄灏

### 1.  蛋白配体PBC校正一般过程

`gmx trjconv`的参数多种多样，可以有多种校正轨迹的组合，自己使用的时候，为了获得好的校正效果，可以在理解参数的基础上自由组合尝试。对蛋白配体体系，我个人一般使用的流程为：

1. 选取某一个原子，以其对体系居中
2. 保证体系中分子的完整性
3. 消除平动和转动

我的体系中包含一个蛋白质和多个游离的配体（不是底物结合在酶口袋里的那种体系），主体模拟相关的文件名字都是md。下面简单叙述我校正周期性的具体步骤。

#### 1.1 居中

首先生成一个体系的索引文件，并在里面添加 center 组，组内只有一个原子，之后会以这个原子为盒子中心对体系进行居中。

```bash
# 把蛋白配体组合到一个组
gmx make_ndx -f md.tpr -o prolig.ndx
# 手动添加一个 center 组
echo -e "\n[ center ]\n500\n" >> prolig.ndx
```

这里选择的是序号为500的原子。

通常教程里提到的这个中心原子的选取，都是通过经验或者试错得到的。比如说你选了一个原子，以它为中心进行了居中，结果发现居中之后的轨迹还是有部分原子在盒子外边或者跨盒子了，然后就重新选一个再试试。一般来讲，试错一两次就大概能获得一个比较好的结果了。

当然，试错是一件容易让人上火的事情，也有比较“理性”的选这个原子的方法。比如说，对于蛋白而言，可以先计算一下蛋白的几何中心，然后选择一个距离蛋白质几何中心最近的原子作为中心原子对体系进行居中。

这里我们以npt.gro文件为例，寻找一个可以对蛋白进行居中的中心原子。下文给出具体的python代码，其中`pro_start`为npt.gro中蛋白质原子部分的起始行号，`pro_num`为蛋白质的原子总数。

```python 
# 读入npt.gro 
with open("npt.gro", "r") as fo:
    lines = fo.readlines()
# 定义几何中心的变量
center_X = 0 
center_Y = 0
center_Z = 0 
# 遍历每一个蛋白的原子，计算几何中心
pro_start= 3 # 自己定义
pro_num = 1000 # 自己定义
# 因为python计数从0开始，所以这里pro_start-1
for line in lines[pro_start-1:pro_start+pro_num-1]:
    # 按列对每一行进行切分
    items = line[20:44].split()
    # 蛋白原子的坐标在第4、5、6列
    center_X += float(items[0])
    center_Y += float(items[1])
    center_Z += float(items[2])
# 计算几何中心的坐标
center_X = center_X/pro_num
center_Y = center_Y/pro_num
center_Z = center_Z/pro_num
# 定义变量存储寻找到的最近原子的信息
# atom_info记录寻找到的原子序号
atom_info = ""
# dist记录寻找到的原子与几何中心的距离
dist = 10
# 再遍历一遍原子，寻找离几何中心最近的原子
for line in lines[pro_start-1:pro_start+pro_num-1]:
    items = line[20:44].split()
    x = float(items[0])
    y = float(items[1])
    z = float(items[2])
    # 计算距离，小于dist就刷新atom_info和dist
    atom_center_dist = ((x-center_X)**2 + (y-center_Y)**2 + (z-center_Z)**2 )**0.5
    if atom_center_dist < dist:
        dist = atom_center_dist
        # 记录此原子信息
        atom_info = line
# 输出中心原子的信息
print(atom_info)
```

最后输出的信息，就是离中心最近的原子了，在第三列写着的就是这个原子的序号。把这个序号写到 center 组里面就可以了。

执行下面的命令对体系进行居中：

```bash
gmx trjconv -s md.tpr -f md.xtc -o center.xtc -n prolig.ndx -pbc atom -center
# 第一次输入要居中的组，选 center 组
# 第二次输入要输出的组，选你自己定义的蛋白配体组
```

#### 1.2 分子完整

对居中之后的轨迹做一遍保证分子完整性的校正。当然可以用`whole`选项保证分子完整性，我这里用下面这条命令：

```bash
gmx trjconv -s md.tpr -f center.xtc -o mol.xtc -n prolig.ndx -pbc mol -ur compact
# 选择蛋白配体组即可
```

#### 1.3 fit一下

如果幸运的话，做完上述两步应该就可以了，我个人习惯还对蛋白去除一下平动和转动，方便查看配体和蛋白质之间的相互运动：

```bash
gmx trjconv -s md.tpr -f mol.xtc -o fit.xtc -n prolig.ndx -fit rot+trans
# 第一次输入，选择对蛋白质进行fit
# 第二次输入，选择蛋白配体组进行轨迹输出
```

不管校正到哪一步了，都可以把轨迹可视化出来，自己visual check一下。我一般习惯把xtc转成pdb，用pymol查看。

```bash
gmx trjconv -s md.tpr -f fit.xtc -o fit.pdb -dt 1000 -n prolig.ndx 
```

加个`-dt 1000`，选择合适的时间间隔，防止输出的pdb文件太大。

### 2. Others

#### 2.1 nojump

上述过程并没有涉及到`-pbc nojump`，但这个参数值得单独讲讲。如它的名字，一旦某个分子跨盒子的话，`nojump`命令会是的原子即是跨越了盒子也照样运动，而不是从盒子的另一边进入盒子。至少对于我的游离配体的体系来说，这个校正存在很大问题。

比方说，我的配体从盒子左边穿出盒子，从右侧进入盒子，然后从右侧结合到蛋白表面；对于这样一个过程，使用了`nojump`的话，会看到这个配体最终出现在蛋白质左侧很远的地方（远超过盒子尺寸）；甚至本来最终蛋白配体在一起的，`nojump`也会硬生生拆散人家，仅仅因为配体跨过一次盒子。这显然是不合理的。

对于底物和酶那种体系来讲，或许配体和蛋白的位置关系变化不大，使用`nojump`应该是很便利的，可以考虑考虑。

`cluster`参数这里也没有涉及。

非常建议大家多看看相关的文档，官方的关于trjconv命令的说明、各种教程、论坛里的问答等等。在对每一个参数都有大致的理解之后，或许校正自己的体系就会容易很多。

#### 2.2 盒子尺寸

大多数蛋白质都是类球形的，这时候使用菱形十二面体等类型的盒子，往往是比较推荐的。我之前做的一个蛋白，它是非常类似于长方体的，某一个方向上的长度远大于另两个方向。建模的时候体系离盒子边缘的空余我倒是留足了，一个长方体盒子。哎，两年前建的模，现在做周期性校正才意识到这个蛋白会转动到蛋白的长轴到盒子短边的方向上，于是我的蛋白同时在左右两边跨盒子，真厉害！怎么都校正不回去，并且意识到，这种两边同时跨盒子的愚蠢错误会导致体系发生一些难以预料的相互作用，遂只好重跑。终于是自己为自己填坑。

最近还发现另一个好玩的事情，使用amberTools2020的tleap建完模之后，转到gromacs跑，跑NVT的时候盒子角落的位置居然出现了真空。也是蛋白配体，水用的TIP3PBOX填充的，不知道为什么会出现这种情况？！这也就导致NPT的时候盒子尺寸会收缩，本来算好的余量就又少了。

哎，麻烦多多。

所以真诚告诫自己，建体系的时候一定要多想，不然分析的时候哭都哭不出来。

今天的文章内容很短，废话很多。

最后祝大家想哭都哭得出来吧！加油！